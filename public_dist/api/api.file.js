let fs=require("fs"),path=require("path"),v4=require("uuid").v4,dataEncrypt=require("../util/crpyto").dataEncrypt,UserModel=require("../model/user").UserModel,ResultResponse=require("../util/resultResponse");function FileUpload(e,o,p){try{if(!o||!p||!p.item)throw"error";var t=path.join(__dirname,"..",process.env.FILE_DIRECTORY_NAME);console.log("BASE_FILE_URL",t);let i=p.item,l=v4()+(new Date).getTime()+path.extname(i.name),a=path.join(t,o,e),s=path.join(a,l);return fs.readdir(a,(e,n)=>{if(e)return new ResultResponse(400,e,"폴더 조회 실패");if(0===n.length)i.mv(s,e=>e?new ResultResponse(400,p,e):UserModel.updateOne({id:o},{profileImg:l}).then(e=>new ResultResponse(200,p)).catch(e=>new ResultResponse(400,p,e)));else for(let t=0;t<n.length;t++){var r=path.join(a,n[t]);fs.unlink(r,e=>{if(e)return new ResultResponse(400,e,"기존 파일 삭제 실패");t===n.length-1&&i.mv(s,e=>e?new ResultResponse(400,p,e):UserModel.updateOne({id:o},{profileImg:l}).then(e=>new ResultResponse(200,p)).catch(e=>new ResultResponse(400,p,e)))})}})}catch(e){}}function FileUpload2(u,f,R){if(f&&R)return new Promise((l,a)=>{var e=path.join(__dirname,"..","..",process.env.FILE_DIRECTORY_NAME);if(Array.isArray(R.item)){let n=R.item,r=[];for(let t=0;t<n.length;t++){var i=Buffer.from(n[t].name,"latin1").toString("utf8"),s=v4()+(new Date).getTime()+path.extname(i),o=path.join(e,f,"file"),s=path.join(o,s),i={name:i,fileName:s.replace(o+"/",""),type:n[t].mimetype,id:f};r.push(i),n[t].mv(s,e=>{if(t===n.length-1){if(e)return a(new ResultResponse(400,r,e));l(new ResultResponse(200,dataEncrypt(r)))}})}}else{let t=R.item,n=Buffer.from(t.name,"latin1").toString("utf8");var p=v4()+(new Date).getTime()+path.extname(n);let r=path.join(e,f,u),i=path.join(r,p);t.mv(i,e=>{if(e)return a(new ResultResponse(400,arr,e));e={name:n,fileName:i.replace(r+"/",""),type:t.mimetype,id:f};l(new ResultResponse(200,dataEncrypt([e])))})}});throw"error"}function FilesDelete(e,t){try{var n=path.join(__dirname,"../..",process.env.FILE_DIRECTORY_NAME),r=path.join(n,e,"file");if(!(t.length<=0)){for(let e=0;e<t.length;e++){var i=t[e].fileName,l=path.join(r,i);fs.existsSync(l)&&fs.unlinkSync(l)}return new ResultResponse(200)}}catch(e){n=new ResultResponse(404,e.stack,e.message);throw console.log("FilesDelete",n),n}}async function FileDownload(e,t){try{var n=path.join(__dirname,"..","..",process.env.FILE_DIRECTORY_NAME),r=path.join(n,e,"file"),i=path.join(r,t);return await fs.createReadStream(i)}catch(e){console.log(e,"fileDownload err")}}module.exports={FileUpload:FileUpload,FileUpload2:FileUpload2,FilesDelete:FilesDelete,FileDownload:FileDownload};// build date : 2024. 12. 18. 오후 2:28:53